<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Broadcaster 3461</title>
  <style>
    body { margin:0; padding:0; background:#fff; }
    video { display:none; }
  </style>
</head>
<body>
  <video id="localVideo" autoplay muted playsinline></video>
  <div id="remoteAudios"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (async function(){
    const socket = io();
    let pcMap = new Map();
    let localStream = null;
    const localVideo = document.getElementById('localVideo');
    const remoteAudios = document.getElementById('remoteAudios');

    // افتح الكاميرا والمايك مباشرة
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      socket.emit('broadcaster');
    } catch(err) {
      console.error("❌ لا يمكن فتح الكاميرا/المايك:", err);
    }

    // مشاهد جديد
    socket.on('watcher', async ({ watcherId }) => {
      const pc = new RTCPeerConnection();
      pcMap.set(watcherId, pc);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // صوت من المشاهد
      pc.ontrack = event => {
        const audioEl = document.createElement('audio');
        audioEl.srcObject = event.streams[0];
        audioEl.autoplay = true;
        remoteAudios.appendChild(audioEl);
      };

      pc.onicecandidate = e => {
        if(e.candidate) socket.emit('candidate', { targetId: watcherId, candidate: e.candidate });
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('offer', { watcherId, sdp: pc.localDescription });
    });

    socket.on('answer', ({ from, sdp }) => {
      const pc = pcMap.get(from);
      if(pc) pc.setRemoteDescription(new RTCSessionDescription(sdp));
    });

    socket.on('candidate', ({ from, candidate }) => {
      const pc = pcMap.get(from);
      if(pc && candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
    });
  })();
  </script>
</body>
</html>
