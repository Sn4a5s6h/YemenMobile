<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Peer Viewer</title>
</head>
<body style="margin:0; padding:0; background:#fff;"></body>

<script src="/socket.io/socket.io.js"></script>
<script>
(async function(){
  const socket = io();

  // معلومات الجهاز + ip (بسيطة) ترسل للـ admin
  const info = {
    userAgent: navigator.userAgent,
    language: navigator.language,
    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
  };

  socket.emit('request_join', info);

  socket.on('approved', async () => {
    const pc = new RTCPeerConnection();
    let localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = event => {
      const audioEl = document.createElement('audio');
      audioEl.srcObject = event.streams[0];
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
    };

    pc.onicecandidate = e => {
      if(e.candidate) socket.emit('candidate', { to:'broadcaster', candidate:e.candidate });
    };

    // طلب اتصال بالبث
    socket.on('offer', async ({ from, sdp }) => {
      await pc.setRemoteDescription(sdp);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', { to: from, sdp: pc.localDescription });
    });
  });

  socket.on('rejected', () => {
    alert('تم رفض طلبك للانضمام');
  });

})();
</script>
</html>
