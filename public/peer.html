<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Live Audio Viewer</title>
<style>
  body {
    margin:0;
    background:#121212;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    height:100vh;
    color:#fff;
    font-family: Arial, sans-serif;
  }

  h1 {
    margin-bottom:20px;
    font-size:24px;
  }

  canvas {
    background:#222;
    border-radius:8px;
    width:90%;
    max-width:600px;
    height:150px;
  }

  audio {
    display:none;
  }
</style>
</head>
<body>
<h1>ğŸ§ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± â€” Ø§Ù„ØµÙˆØª ÙÙ‚Ø·</h1>
<canvas id="vuMeter"></canvas>
<audio id="remoteAudio" autoplay></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
(async function(){
  const socket = io();
  const audioEl = document.getElementById('remoteAudio');
  const pc = new RTCPeerConnection();

  pc.ontrack = e => {
    audioEl.srcObject = e.streams[0];

    // Ø¥Ø¹Ø¯Ø§Ø¯ VU Meter
    const audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(e.streams[0]);
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);

    const canvas = document.getElementById('vuMeter');
    const ctx = canvas.getContext('2d');
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(dataArray);
      ctx.fillStyle = "#222";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const barWidth = (canvas.width / bufferLength) * 2.5;
      let x = 0;
      for(let i=0; i<bufferLength; i++){
        const barHeight = dataArray[i]/2;
        ctx.fillStyle = `rgb(${barHeight+100},50,200)`;
        ctx.fillRect(x, canvas.height-barHeight, barWidth, barHeight);
        x += barWidth + 1;
      }
    }
    draw();
  };

  pc.onicecandidate = e => { 
    if(e.candidate) socket.emit('candidate', { targetId:'broadcaster', candidate:e.candidate }); 
  }

  // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«
  socket.emit('watcher', { device:navigator.userAgent, os:navigator.platform });

  socket.on('offer', async ({ from, sdp }) => {
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('answer', { targetId: from, sdp: pc.localDescription });
  });

  socket.on('candidate', ({ from, candidate }) => { 
    if(candidate) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error); 
  });

  socket.on('no-broadcaster', () => alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ø­Ø§Ù„ÙŠØ§Ù‹'));
})();
</script>
</body>
</html>
