<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Viewer — Live Stream</title>
</head>
<body>
<video id="remoteVideo" autoplay playsinline></video>
<script src="/socket.io/socket.io.js"></script>
<script>
(async function() {
  const socket = io();
  const pc = new RTCPeerConnection();
  const videoEl = document.getElementById('remoteVideo');

  pc.ontrack = event => {
    videoEl.srcObject = event.streams[0];
  };

  pc.onicecandidate = e => {
    if(e.candidate) socket.emit('candidate', { targetId: 'broadcaster', candidate: e.candidate });
  };

  // طلب الانضمام للبث
  socket.emit('watcher', socket.id);

  socket.on('offer', async ({ from, sdp }) => {
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('answer', { from, sdp: pc.localDescription });
  });

  socket.on('candidate', ({ from, candidate }) => {
    if(candidate) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
  });

  socket.on('no-broadcaster', () => alert('لا يوجد بث مباشر حالياً'));
})();
</script>
</body>
</html>
