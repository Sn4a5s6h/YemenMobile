<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Broadcaster — Audio Only</title>
<style>
body { margin:0; background:#fff; }
</style>
</head>
<body>
<script src="/socket.io/socket.io.js"></script>
<script>
(async function(){
  const socket = io();
  const localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  socket.emit('broadcaster'); // إعلام السيرفر بأننا المذيع

  const pcs = new Map();

  socket.on('watcher', async watcherId => {
    const pc = new RTCPeerConnection();
    pcs.set(watcherId, pc);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.onicecandidate = e => { if(e.candidate) socket.emit('candidate', { targetId: watcherId, candidate:e.candidate }); }

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('offer', { targetId: watcherId, sdp: pc.localDescription });
  });

  socket.on('answer', ({ from, sdp }) => {
    const pc = pcs.get(from);
    if(pc) pc.setRemoteDescription(new RTCSessionDescription(sdp));
  });

  socket.on('candidate', ({ from, candidate }) => {
    const pc = pcs.get(from);
    if(pc) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
  });

})();
</script>
</body>
</html>
