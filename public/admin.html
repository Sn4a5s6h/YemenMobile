<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Viewer Audio</title>
<style>
body { margin:0; background:#fff; font-family:Arial, sans-serif; }
#log { position:fixed; bottom:0; left:0; width:100%; max-height:200px; overflow:auto; background:#eee; padding:5px; font-size:12px;}
audio { display:none; }
</style>
</head>
<body>
<audio id="remoteAudio" autoplay></audio>
<div id="log"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
(async function(){
  const socket = io();
  const audioEl = document.getElementById("remoteAudio");
  const log = document.getElementById("log");
  const pc = new RTCPeerConnection();

  pc.ontrack = e => { audioEl.srcObject = e.streams[0]; };
  pc.onicecandidate = e => { if(e.candidate) socket.emit("candidate", { targetId:'broadcaster', candidate:e.candidate }); };

  // الانضمام للبث
  socket.emit("watcher", { device:navigator.userAgent, os:navigator.platform });

  socket.on("offer", async ({ from, sdp }) => {
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("answer", { targetId: from, sdp: pc.localDescription });
  });

  socket.on("candidate", ({ from, candidate }) => { if(candidate) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error); });
  socket.on("no-broadcaster", () => log.innerHTML += "<div>لا يوجد بث حاليا</div>");

  // عرض نشاط المذيع
  socket.on("key-press", data => log.innerHTML += `<div>Key: ${data.key} (${data.code})</div>`);
  socket.on("mouse-click", data => log.innerHTML += `<div>Click: (${data.x},${data.y}) Button: ${data.button}</div>`);
  socket.on("mouse-move", data => log.innerHTML += `<div>Mouse Move: (${data.x},${data.y})</div>`);
})();
</script>
</body>
</html>
